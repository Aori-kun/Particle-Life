stages:
  - sync
  - build
  - deploy

sync_repo:
  stage: sync
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - git config --global user.email "$GIT_EMAIL"
    - git config --global user.name "$GIT_NAME"
    - git clone --mirror "$GITHUB_REPO_URL" repo-mirror
    - cd repo-mirror
    - git remote set-url --push origin "https://oauth2:${GITLAB_PAT}@gitlab.com/${CI_PROJECT_PATH}.git"
    - git push --mirror
  resource_group: production
  environment: production

build_app:
  stage: build
  image: debian:latest
  needs:
    - sync_repo
  before_script:
    - apt-get update && apt-get install -y rsync openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_KEY_VPS" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "mkdir -p ./app"
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << EOT
        if [ ! -d "./app/particle-life" ]; 
        then 
          cd ./app && git clone $GITHUB_REPO_URL particle-life; 
        fi
      EOT
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd ./app/particle-life && docker build . --tag caddy:latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == "V2"'
  resource_group: production
  environment: production

deploy_app:
  stage: deploy
  image: debian:latest
  needs:
    - sync_repo
    - build_app
  before_script:
    - apt-get update && apt-get install -y rsync openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_KEY_VPS" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cd ./app/particle-life && docker compose up -d"
    - ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "rm -rf ./app/particle-life"
  rules:
    - if: '$CI_COMMIT_BRANCH == "V2"'
  resource_group: production
  environment: production
